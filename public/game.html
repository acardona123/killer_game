<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Killer — Lobby & Game</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; max-width:900px; margin:20px auto; background:#f5f5f7; color:#111 }
    .container { background:#fff; padding:20px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,.04) }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px }
    h1 { margin:0; font-size:20px }
    .game-code { font-size:14px; color:#0b66c3 }
    .you-label { font-size:14px; color:#333; font-weight:700 }
    .connection-status { text-align:center; margin-bottom:12px; padding:8px; border-radius:6px }
    .connected { background:#e6ffed; color:#0b662b; border:1px solid #cfead1 }
    .disconnected { background:#fff0f0; color:#7a1f1f; border:1px solid #f2c2c2 }
    .players-container { margin-bottom:18px }
    .player-item { display:flex; justify-content:space-between; align-items:center; padding:12px; border-radius:6px; margin-bottom:8px; border:1px solid #eee; background:#fbfbfd }
    .player-name { font-weight:700 }
    .player-status { padding:6px 10px; border-radius:6px; font-size:13px }
    .status-not-joined { background:#fff3f3; color:#7a1f1f }
    .status-alive { background:#e8f8ee; color:#0b662b }
    .status-dead { background:#f0f0f0; color:#666 }
    .game-in-progress { text-align: center; padding: 40px 20px; }
    .game-in-progress h3 { margin-bottom: 16px; color: #333; }
    .game-in-progress p { margin-bottom: 24px; color: #666; line-height: 1.5; }
    .controls { text-align:center; margin-top:14px }
    .btn { padding:10px 16px; border-radius:8px; border:0; cursor:pointer; font-weight:700 }
    .btn.primary { background:#2563eb; color:#fff }
    .btn.ghost { background:transparent; border:1px solid #ddd }
    .btn.danger { background:#ef4444; color:#fff }
    .smallmuted { color:#666; font-size:13px }
    .hidden { display:none !important }
    .selection-phase { background:#f3f6f9; padding:12px; border-radius:8px; margin-bottom:14px }
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:12px; z-index:1000 }
    .modal-backdrop.open { display:flex }
    .modal { background:#fff; padding:18px; border-radius:10px; width:100%; max-width:560px; box-shadow:0 10px 30px rgba(0,0,0,.2) }
    .field { margin:10px 0 }
    input[type="text"] { width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; box-sizing:border-box }
    ul.list { list-style:none; padding:0; margin:0 }
    li.list-item { padding:10px 6px; border-bottom:1px dashed #eee; display:flex; justify-content:space-between; align-items:center }
    #alert { margin-top:12px; padding:10px; border-radius:8px; background:#fffbe6; border:1px solid #ffecb5; color:#6b4a00 }
    .pill { padding:6px 10px; border-radius:999px; border:1px solid #ddd; font-size:13px }
    .select-btn.selected { background:#2563eb; color:#fff }
    button:disabled { opacity: 0.5; cursor: not-allowed;}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Killer</h1>
        <div id="gameCode" class="game-code">Loading game…</div>
      </div>
      <div id="youNameContainer" class="you-label">You: <span id="youName">—</span></div>
    </header>

    <div id="connectionStatus" class="connection-status disconnected">Connecting...</div>

    <!-- GAME IN PROGRESS VIEW (for unauthenticated users) -->
    <div id="viewGameInProgress" class="hidden">
      <div class="game-in-progress">
        <h3>Game In Progress</h3>
        <p>This game has already started. If you were previously playing, you can reclaim your identity to rejoin as a spectator or continue playing.</p>
        <button id="reclaimInGameBtn" class="btn primary">Reclaim Identity</button>
      </div>
    </div>

    <!-- SELECTION / LOBBY -->
    <div id="lobbySection">
      <div id="selectionPhase" class="selection-phase">
        <div class="smallmuted">Select your identity</div>
        <p>You have tentatively selected: <strong id="selectedPlayerName">None</strong></p>
        <div style="text-align:center; margin-top:8px; display:flex; gap:8px; justify-content:center;">
          <button id="confirmIdentityBtn" class="btn primary" disabled>Confirm My Identity</button>
          <button id="reclaimIdentityBtn" class="btn ghost">Reclaim Existing Identity</button>
        </div>
      </div>

      <div class="players-container">
        <h3>Players</h3>
        <div id="playersList">Loading players…</div>
      </div>

      <!-- NOTE: inline style display:none like your original so start visibility uses style.display toggles -->
      <div id="startGameContainer" style="display:none; text-align:center; margin-top:8px">
        <button id="startGameBtn" class="btn danger" disabled>Start Game</button>
        <div class="smallmuted" style="margin-top:8px">All players must join before the creator can start</div>
      </div>
    </div>

    <!-- GAMEPLAY (alive) -->
    <div id="viewAlive" class="hidden">
      <h3>Your Mission</h3>
      <p class="smallmuted">Target: <strong id="targetName">—</strong></p>
      <p class="smallmuted">Task: <span id="taskText">—</span></p>
      <div style="margin-top:12px">
        <button id="btnEliminate" class="btn danger">ELIMINATE TARGET</button>
        <span id="cooldownNote" class="smallmuted" style="margin-left:10px"></span>
      </div>
    </div>

    <!-- GRAVEYARD (dead) -->
    <div id="viewDead" class="hidden">
      <h3>You have been eliminated ☠</h3>
      <p class="smallmuted">You are a spectator. Roster below updates in real time.</p>
      <ul id="graveList" class="list" style="margin-top:12px"></ul>
    </div>

    <div id="alert" class="hidden"></div>
  </div>

  <!-- Confirm eliminate modal (typed-confirm) -->
  <div id="confirmModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Confirm Elimination</h3>
      <p id="confirmSummary" class="smallmuted"></p>
      <div class="field">
        <div class="smallmuted">Type the target's exact name to confirm (case-insensitive):</div>
        <input id="confirmInput" type="text" placeholder="Type target name" autocomplete="off" />
        <div id="confirmError" class="smallmuted" style="color:red; margin-top:6px; display:none;"></div>
      </div>
      <div style="text-align:right; margin-top:8px">
        <button id="confirmCancel" class="btn ghost">Cancel</button>
        <button id="confirmYes" class="btn danger" disabled>Yes — Confirm</button>
      </div>
    </div>
  </div>

  <!-- Kill challenge modal (target) -->
  <div id="challengeModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Elimination Challenge</h3>
      <p id="challengeText" class="smallmuted"></p>
      <div style="text-align:right; margin-top:12px">
        <button id="challengeDeny" class="btn ghost">Deny</button>
        <button id="challengeConfirm" class="btn primary">Confirm</button>
      </div>
    </div>
  </div>
  
<!-- Confirm Identity Modal (Set PIN) -->
  <div id="confirmIdentityModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3 id="confirmIdentityModalTitle">Set Your PIN</h3>
      <p id="confirmIdentityModalText" class="smallmuted">Enter a 4-digit PIN to secure your identity. You'll need this PIN to reclaim your identity if you lose your session.</p>
      <div class="field">
        <input id="confirmIdentityInput" type="password" placeholder="Enter 4-digit PIN" maxlength="4" autocomplete="off" />
        <div id="confirmIdentityError" class="smallmuted" style="color:red; margin-top:6px; display:none;"></div>
      </div>
      <div style="text-align:right; margin-top:8px">
        <button id="confirmIdentityCancel" class="btn ghost">Cancel</button>
        <button id="confirmIdentityConfirm" class="btn primary" disabled>Confirm</button>
      </div>
    </div>
  </div>

  <!-- Reclaim Identity Modal -->
  <div id="reclaimModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Reclaim Your Identity</h3>
      <p class="smallmuted">Enter your player name and PIN to reclaim your identity.</p>
      <div class="field">
        <input id="reclaimNameInput" type="text" placeholder="Enter your player name" autocomplete="off" />
      </div>
      <div class="field">
        <input id="reclaimPinInput" type="password" placeholder="Enter your 4-digit PIN" maxlength="4" autocomplete="off" />
      </div>
      <div id="reclaimError" class="smallmuted" style="color:red; margin-top:6px; display:none;"></div>
      <div style="text-align:right; margin-top:8px">
        <button id="reclaimCancel" class="btn ghost">Cancel</button>
        <button id="reclaimSubmit" class="btn primary" disabled>Reclaim Identity</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const socket = io();


  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"']/g, (s) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s]));
  }

  // Get game code
  function getGameCode() {
    const fromQuery = new URLSearchParams(window.location.search).get('gameCode') || new URLSearchParams(window.location.search).get('game');
    if (fromQuery) return fromQuery;
    const pathLast = window.location.pathname.split('/').filter(Boolean).pop();
    
    return pathLast;
  }

  const gameCode = getGameCode();
  document.getElementById('gameCode').textContent = gameCode ? `Game: ${gameCode}` : 'Game';

  // Storage keys
  const creatorKey = `creator_${gameCode}`;
  const sessionKey = `session_${gameCode}`;
  const playerNameKey = `player_name_${gameCode}`;

  // Elements
  const connectionStatus = document.getElementById('connectionStatus');
  const playersListEl = document.getElementById('playersList');
  const selectedNameEl = document.getElementById('selectedPlayerName');
  const confirmIdentityBtn = document.getElementById('confirmIdentityBtn');
  const reclaimIdentityBtn = document.getElementById('reclaimIdentityBtn'); 
  const startGameContainer = document.getElementById('startGameContainer');
  const startGameBtn = document.getElementById('startGameBtn');

  const selectionPhase = document.getElementById('selectionPhase');

  const viewAlive = document.getElementById('viewAlive');
  const viewDead = document.getElementById('viewDead');
  const targetNameEl = document.getElementById('targetName');
  const taskTextEl = document.getElementById('taskText');
  const btnEliminate = document.getElementById('btnEliminate');
  const cooldownNote = document.getElementById('cooldownNote');

  const confirmModal = document.getElementById('confirmModal');
  const confirmSummary = document.getElementById('confirmSummary');
  const confirmInput = document.getElementById('confirmInput');
  const confirmCancel = document.getElementById('confirmCancel');
  const confirmYes = document.getElementById('confirmYes');

  const challengeModal = document.getElementById('challengeModal');
  const challengeText = document.getElementById('challengeText');
  const challengeDeny = document.getElementById('challengeDeny');
  const challengeConfirm = document.getElementById('challengeConfirm');

  const graveList = document.getElementById('graveList');
  const alertBox = document.getElementById('alert');
  const youNameSpan = document.getElementById('youName');
  
  const confirmIdentityModal = document.getElementById('confirmIdentityModal');
  const confirmIdentityModalTitle = document.getElementById('confirmIdentityModalTitle');
  const confirmIdentityModalText = document.getElementById('confirmIdentityModalText');
  const confirmIdentityInput = document.getElementById('confirmIdentityInput');
  const confirmIdentityCancel = document.getElementById('confirmIdentityCancel');
  const confirmIdentityConfirm = document.getElementById('confirmIdentityConfirm');
  const confirmIdentityError = document.getElementById('confirmIdentityError');

  const reclaimModal = document.getElementById('reclaimModal');
  const reclaimNameInput = document.getElementById('reclaimNameInput');
  const reclaimInput = document.getElementById('reclaimPinInput');
  const reclaimError = document.getElementById('reclaimError');
  const reclaimCancel = document.getElementById('reclaimCancel');
  const reclaimSubmit = document.getElementById('reclaimSubmit');

  const viewGameInProgress = document.getElementById('viewGameInProgress');
  const reclaimInGameBtn = document.getElementById('reclaimInGameBtn');

  // State
  let tentativelySelected = null;
  let mySession = localStorage.getItem(sessionKey) || null;
  let myName = localStorage.getItem(playerNameKey) || null;
  let pinMode = 'new'; // 'new' or 'reclaim'
  let pendingPlayerName = null;
  // IMPORTANT: detect creator via the exact key your create UI sets (reuse original pattern)
  let isCreator = !!localStorage.getItem(creatorKey);
  let role = 'lobby'; // 'lobby' | 'alive' | 'dead'
  let currentTarget = null;
  let currentTask = null;
  let pendingKiller = null;
  let eliminateCooldown = false;
  let gameStarted = false;

  function show(el){ el.classList.remove('hidden'); }
  function hide(el){ el.classList.add('hidden'); }
  function toast(msg){
    alertBox.textContent = msg;
    show(alertBox);
    setTimeout(()=> hide(alertBox), 2800);
  }

  // initialize displayed name from localStorage (if present)
  function updateDisplayedName(name) {
    myName = name || null;
    if (myName) {
      youNameSpan.textContent = myName;
    } else {
      youNameSpan.textContent = '—';
    }
  }
  updateDisplayedName(localStorage.getItem(playerNameKey));

  // Show appropriate view based on game state and authentication
  function updateViewVisibility() {
    // Reset all views first
    hide(viewGameInProgress);
    hide(lobbySection);
    hide(viewAlive);
    hide(viewDead);
    
    // If game has started and user doesn't have a valid session
    if (gameStarted && !mySession) {
      show(viewGameInProgress);
      return;
    }
    
    // Show appropriate view based on role
    if (role === 'alive') {
      show(viewAlive);
    } else if (role === 'dead') {
      show(viewDead);
    } else {
      show(lobbySection);
    }
  }

  socket.on('connect', () => {
    connectionStatus.textContent = 'Connected to game';
    connectionStatus.className = 'connection-status connected';
    socket.emit('join-game', gameCode);
    if (mySession) socket.emit('identify', { session_token: mySession, game_id: gameCode });
  });
  socket.on('disconnect', () => {
    connectionStatus.textContent = 'Disconnected - trying to reconnect...';
    connectionStatus.className = 'connection-status disconnected';
  });

  // Render the player list client-side using server data; include select/cancel buttons
  function renderPlayerList(players) {
    if (!players || players.length === 0) {
      playersListEl.innerHTML = '<p>No players found.</p>';
      return;
    }
    updateViewVisibility();
    const html = players.map(p => {
      const isMe = p.session_token && (p.session_token === mySession);
      const canSelect = p.status === 'not-joined' && !mySession && !gameStarted;
      const isTent = tentativelySelected === p.name;
      const statusClass = p.status === 'alive' ? 'status-alive' : 'status-not-joined';
      const statusText = p.status === 'alive' ? 'Joined' : 'Not Joined';
      const selectBtn = canSelect ? `<button class="btn ghost select-btn ${isTent ? 'selected' : ''}" data-name="${escapeHtml(p.name)}">${isTent? 'Selected' : 'Select'}</button>` : '';
      const myCancelBtn = isMe ? `<button class="btn ghost cancel-btn" data-name="${escapeHtml(p.name)}">Cancel</button>` : '';
      return `
        <div class="player-item">
          <div style="display:flex;gap:12px;align-items:center">
            <div class="player-name">${escapeHtml(p.name)} ${isMe ? '(You)' : ''}</div>
            <div class="player-status ${statusClass} pill">${statusText}</div>
          </div>
          <div>
            ${selectBtn} ${myCancelBtn}
          </div>
        </div>
      `;
    }).join('');
    playersListEl.innerHTML = html;

    // Update selection UI
    selectedNameEl.textContent = tentativelySelected || 'None';
    confirmIdentityBtn.disabled = !tentativelySelected;
  }

  // Simple HTML escaper for safety when rendering names
  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"']/g, (s) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s]));
  }

  // Delegated click handler for select/cancel buttons
  playersListEl.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    if (btn.classList.contains('select-btn')) {
      const name = btn.dataset.name;
      if (!name) return;
      if (tentativelySelected === name) tentativelySelected = null; else tentativelySelected = name;
      socket.emit('join-game', gameCode);
      selectedNameEl.textContent = tentativelySelected || 'None';
      confirmIdentityBtn.disabled = !tentativelySelected;
    } else if (btn.classList.contains('cancel-btn')) {
      if (!mySession) return;
      socket.emit('cancel-identity', { gameCode, sessionToken: mySession });
    }
  });

  // identity confirm (Set PIN)
  confirmIdentityBtn.addEventListener('click', () => {
    if (!tentativelySelected) return;
    pendingPlayerName = tentativelySelected;
    confirmIdentityInput.value = '';
    confirmIdentityConfirm.disabled = true;
    confirmIdentityError.style.display = 'none';
    confirmIdentityModal.classList.add('open');
    confirmIdentityInput.focus();
  });

  // PIN input validation
  confirmIdentityInput.addEventListener('input', () => {
    const value = confirmIdentityInput.value.trim();
    if (value === '') {
      confirmIdentityConfirm.disabled = true;
      confirmIdentityError.style.display = 'none';
    } else if (!/^\d{4}$/.test(value)) {
      confirmIdentityConfirm.disabled = true;
      confirmIdentityError.textContent = 'PIN must be exactly 4 digits';
      confirmIdentityError.style.display = 'block';
    } else {
      confirmIdentityConfirm.disabled = false;
      confirmIdentityError.style.display = 'none';
    }
  });

  confirmIdentityInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !confirmIdentityConfirm.disabled) {
        confirmIdentityConfirm.click();
    }
  });

  confirmIdentityCancel.addEventListener('click', () => {
    confirmIdentityModal.classList.remove('open');
  });

  confirmIdentityConfirm.addEventListener('click', () => {
    const pin = confirmIdentityInput.value.trim();
    if (pin.length === 4 && /^\d{4}$/.test(pin) && pendingPlayerName) {
      socket.emit('claim-identity', { gameCode, playerName: pendingPlayerName, pin });
      confirmIdentityModal.classList.remove('open');
    }
  });

  // Show reclaim modal
  reclaimIdentityBtn.addEventListener('click', () => {
    reclaimNameInput.value = '';
    reclaimInput.value = '';
    reclaimError.style.display = 'none';
    reclaimSubmit.disabled = true;
    reclaimModal.classList.add('open');
    reclaimNameInput.focus();
  });

  // Reclaim modal validation
  function validateReclaimInputs() {
    const name = reclaimNameInput.value.trim();
    const pin = reclaimInput.value.trim();
    reclaimSubmit.disabled = !(name.length > 0 && pin.length === 4 && /^\d{4}$/.test(pin));
    reclaimError.style.display = 'none';
  }
  reclaimNameInput.addEventListener('input', validateReclaimInputs);
  reclaimInput.addEventListener('input', validateReclaimInputs);
  reclaimInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !reclaimSubmit.disabled) {
        reclaimSubmit.click();
    }
  });

  reclaimCancel.addEventListener('click', () => {
    reclaimModal.classList.remove('open');
  });

  reclaimSubmit.addEventListener('click', () => {
    const name = reclaimNameInput.value.trim();
    const pin = reclaimInput.value.trim();
    if (name && pin.length === 4 && /^\d{4}$/.test(pin)) {
      socket.emit('reclaim-identity', { gameCode, playerName: name, pin });
      reclaimModal.classList.remove('open');
    }
  });

  // handle server identity responses
  socket.on('identity-confirmed', (data) => {
    mySession = data.sessionToken;
    myName = data.playerName;
    localStorage.setItem(sessionKey, mySession);
    localStorage.setItem(playerNameKey, myName);
    updateDisplayedName(myName);
    updateViewVisibility();
    toast(`You are now ${myName}`);
    socket.emit('join-game', gameCode);
  });

  socket.on('identity-reclaimed', (data) => {
    mySession = data.sessionToken;
    myName = data.playerName;
    localStorage.setItem(sessionKey, mySession);
    localStorage.setItem(playerNameKey, myName);
    updateDisplayedName(myName);
    updateViewVisibility();
    toast(`Identity reclaimed: ${myName}`);
    socket.emit('join-game', gameCode);
  });

  socket.on('identity-canceled', (data) => {
    mySession = null;
    myName = null;
    localStorage.removeItem(sessionKey);
    localStorage.removeItem(playerNameKey);
    updateDisplayedName(null);                 // <-- clear visible name
    tentativelySelected = null;
    selectedNameEl.textContent = 'None';
    confirmIdentityBtn.disabled = true;
    updateViewVisibility();
    socket.emit('join-game', gameCode);
  });

    socket.on('session-invalidated', () => {
      // Clear session and player name from storage
      mySession = null;
      myName = null;
      localStorage.removeItem(sessionKey);
      localStorage.removeItem(playerNameKey);
      updateDisplayedName(null);
      tentativelySelected = null;
      selectedNameEl.textContent = 'None';
      confirmIdentityBtn.disabled = true;
      show(selectionPhase);
      reclaimIdentityBtn.style.display = 'inline-block';
      reclaimIdentityBtn.disabled = false;
      toast('Your session was reclaimed elsewhere. Please select or reclaim your identity.');
      socket.emit('join-game', gameCode);
  });

  // When server sends player-list-update: render it
  socket.on('player-list-update', (players) => {
    renderPlayerList(players || []);

    // Check if we have a session and find our player data
    if (mySession) {
      const myPlayer = players.find(p => p.session_token === mySession);
      if (myPlayer) {
        // Update our role based on the server's data
        if (myPlayer.status === 'eliminated') {
          role = 'dead';
          updateViewVisibility();
          fillGraveyard(players || []);
        }
      }
    }

    // creator logic for start button — use inline style toggles like original code
    if (isCreator) {
      startGameContainer.style.display = 'block';
      const allJoined = players.length > 0 && players.every(p => p.status === 'alive');
      startGameBtn.disabled = !allJoined;
      startGameBtn.textContent = allJoined ? 'Start Game' : `Waiting (${players.filter(p=>p.status==='alive').length}/${players.length})`;
    } else {
      startGameContainer.style.display = 'none';
    }
    // If we are dead, show roster in grave
    if (role === 'dead') fillGraveyard(players || []);
  });

  // creator start
  if (isCreator) startGameContainer.style.display = 'block';
  startGameBtn.addEventListener('click', () => {
    const creatorToken = localStorage.getItem(creatorKey);
    if (!creatorToken) { toast('Creator token missing'); return; }
    socket.emit('start-game', { gameCode, creatorToken });
  });

  // your assignment private DM
  socket.on('your-assignment', ({ target, task }) => {
    role = 'alive';
    currentTarget = target;
    currentTask = task;
    targetNameEl.textContent = currentTarget ? currentTarget.name : '—';
    taskTextEl.textContent = currentTask || '—';
    updateViewVisibility();
  });

  socket.on('game-started', () => {
    gameStarted = true;
    toast('Game started!');
    socket.emit('join-game', gameCode); // cause lobby update + server DMs
  });

  // eliminate flow - typed confirm modal
  btnEliminate.addEventListener('click', () => {
    if (role !== 'alive') return;
    if (eliminateCooldown) return;
    if (!currentTarget || !currentTask) { toast('No assigned target or task'); return; }
    confirmSummary.textContent = `You are about to claim the elimination of "${currentTarget.name}" by doing: "${currentTask}". This will send a challenge to them for verification.`;
    confirmInput.value = '';
    confirmYes.disabled = true;
    confirmModal.classList.add('open');
    confirmInput.focus();
  });

    confirmInput.addEventListener('input', () => {
    const typed = confirmInput.value.trim().toLowerCase();
    const targetName = (currentTarget && currentTarget.name) ? currentTarget.name.trim().toLowerCase() : '';
    
    if (typed === '') {
    confirmYes.disabled = true;
    confirmError.style.display = 'none';
    } else if (typed !== targetName) {
    confirmYes.disabled = true;
    confirmError.textContent = 'Target name does not match!';
    confirmError.style.display = 'block';
    } else {
    confirmYes.disabled = false;
    confirmError.style.display = 'none';
    }
    });

    confirmInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !confirmYes.disabled) {
        confirmYes.click();
    }
    });

  confirmCancel.addEventListener('click', () => { confirmModal.classList.remove('open'); });

  confirmYes.addEventListener('click', () => {
    confirmModal.classList.remove('open');
    eliminateCooldown = true;
    btnEliminate.disabled = true;
    cooldownNote.textContent = 'Cooldown...';
    setTimeout(()=> { eliminateCooldown = false; btnEliminate.disabled = false; cooldownNote.textContent=''; }, 1000);

    const sessionToken = mySession;
    socket.emit('claim-kill', { sessionToken, session_token: sessionToken, gameCode });
    toast('Claim sent — waiting for target response');
  });

  // target challenge modal
  socket.on('kill-challenge', ({ killer_id, killer_name, task }) => {
    pendingKiller = killer_id;
    challengeText.textContent = `${killer_name} claims they eliminated you by making you do: "${task}". Do you confirm?`;
    challengeModal.classList.add('open');
  });

  challengeDeny.addEventListener('click', () => {
    challengeModal.classList.remove('open');
    if (!pendingKiller) return;
    socket.emit('resolve-kill', { sessionToken: mySession, session_token: mySession, killer_id: pendingKiller, answer: 'deny' });
    pendingKiller = null;
    toast('You denied the claim');
  });

  challengeConfirm.addEventListener('click', () => {
    challengeModal.classList.remove('open');
    if (!pendingKiller) return;
    socket.emit('resolve-kill', { sessionToken: mySession, session_token: mySession, killer_id: pendingKiller, answer: 'confirm' });
    pendingKiller = null;
    toast('You confirmed the claim');
  });

  // Reclaim button in game progress view
  reclaimInGameBtn.addEventListener('click', () => {
    reclaimNameInput.value = '';
    reclaimInput.value = '';
    reclaimError.style.display = 'none';
    reclaimSubmit.disabled = true;
    reclaimModal.classList.add('open');
    reclaimNameInput.focus();
  });

  socket.on('kill-denied', () => { toast('Your kill was denied.'); });

  socket.on('player-eliminated', ({ name, id }) => {
    if (role === 'dead') {
     toast(`${name} eliminated`);
    socket.emit('join-game', gameCode);
  }
  });

  socket.on('you-eliminated', () => {
    role = 'dead';
    updateViewVisibility();
    socket.emit('join-game', gameCode);
  });

  socket.on('new-target', ({ target, task }) => {
    currentTarget = target || null;
    currentTask = task || null;
    if (role === 'alive') {
      targetNameEl.textContent = currentTarget ? currentTarget.name : '—';
      taskTextEl.textContent = currentTask || '—';
    }
    toast('New target received');
  });

  socket.on('game-over', ({ winner_id, winner_name }) => {
    toast(`Game over — winner: ${winner_name}`);
  });

  socket.on('navigate-victory', ({ gameCode }) => {
    window.location.href = `/victory.html?gameCode=${gameCode}`;
  });

  // Track game state from server events
  socket.on('game-state', (state) => {
      // Redirect to victory page if game is finished
    if (state === 'finished') {
      window.location.href = `/victory.html?gameCode=${gameCode}`;
      return;
    }
    if ( state === 'active')
      gameStarted = state === 'active';
    updateViewVisibility();
  });

  socket.on('game-created', () => {
    gameStarted = false;
    updateViewVisibility();
  });

  socket.on('game-ended', () => {
    gameStarted = false;
    updateViewVisibility();
  });

  function fillGraveyard(players){
    graveList.innerHTML = '';
    (players || []).forEach(p => {
      const li = document.createElement('li');
      li.className = 'list-item';
      li.innerHTML = `<div>${escapeHtml(p.name)}</div><div class="pill">${p.status === 'alive' ? '♥ alive' : '☠ eliminated'}</div>`;
      graveList.appendChild(li);
    });
  }

  // initial UI
  if (mySession) hide(selectionPhase);
  else {
    show(selectionPhase);
    confirmIdentityBtn.disabled = true;
    reclaimIdentityBtn.style.display = 'inline-block';
    reclaimIdentityBtn.disabled = false;
  }

  // Ensure startGameContainer visible if creator (initial)
  if (isCreator) startGameContainer.style.display = 'block';
})();
</script>
</body>
</html>
