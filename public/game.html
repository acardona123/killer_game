<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Killer — Lobby & Game</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="/css/game.css">
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Killer</h1>
        <div id="gameCode" class="game-code">Loading game…</div>
      </div>
      <div id="youNameContainer" class="you-label">You: <span id="youName">—</span></div>
    </header>

    <div id="connectionStatus" class="connection-status disconnected">Connecting...</div>

    <!-- GAME IN PROGRESS VIEW (for unauthenticated users) -->
    <div id="viewGameInProgress" class="hidden">
      <div class="game-in-progress">
        <h3>Game In Progress</h3>
        <p>This game has already started. If you were previously playing, you can reclaim your identity to rejoin as a spectator or continue playing.</p>
        <button id="reclaimInGameBtn" class="btn primary">Reclaim Identity</button>
      </div>
    </div>

    <!-- SELECTION / LOBBY -->
    <div id="lobbySection">
      <div id="selectionPhase" class="selection-phase">
        <div class="smallmuted">Select your identity</div>
        <p>You have tentatively selected: <strong id="selectedPlayerName">None</strong></p>
        <div style="text-align:center; margin-top:8px; display:flex; gap:8px; justify-content:center;">
          <button id="confirmIdentityBtn" class="btn primary" disabled>Confirm My Identity</button>
          <button id="reclaimLobbyBtn" class="btn ghost">Reclaim Existing Identity</button>
        </div>
      </div>

      <div class="players-container">
        <h3>Players</h3>
        <div id="playersList">Loading players…</div>
      </div>

      <!-- NOTE: inline style display:none like your original so start visibility uses style.display toggles -->
      <div id="startGameContainer" style="display:none; text-align:center; margin-top:8px">
        <button id="startGameBtn" class="btn danger" disabled>Start Game</button>
        <div class="smallmuted" style="margin-top:8px">All players must join before the creator can start</div>
      </div>
    </div>

    <!-- GAMEPLAY (alive) -->
    <div id="viewAlive" class="hidden">
      <h3>Your Mission</h3>
      <p class="smallmuted">Target: <strong id="targetName">—</strong></p>
      <p class="smallmuted">Task: <span id="taskText">—</span></p>
      <div style="margin-top:12px">
        <button id="btnEliminate" class="btn danger">ELIMINATE TARGET</button>
        <span id="cooldownNote" class="smallmuted" style="margin-left:10px"></span>
      </div>
    </div>

    <!-- GRAVEYARD (dead) -->
    <div id="viewDead" class="hidden">
      <h3>You have been eliminated ☠</h3>
      <p class="smallmuted">You are a spectator. Roster below updates in real time.</p>
      <ul id="graveList" class="list" style="margin-top:12px"></ul>
    </div>

    <div id="alert" class="hidden"></div>
  </div>

  <!-- Confirm eliminate modal (typed-confirm) -->
  <div id="confirmModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Confirm Elimination</h3>
      <p id="confirmSummary" class="smallmuted"></p>
      <div class="field">
        <div class="smallmuted">Type the target's exact name to confirm (case-insensitive):</div>
        <input id="confirmInput" type="text" placeholder="Type target name" autocomplete="off" />
        <div id="confirmError" class="smallmuted" style="color:red; margin-top:6px; display:none;"></div>
      </div>
      <div style="text-align:right; margin-top:8px">
        <button id="confirmCancel" class="btn ghost">Cancel</button>
        <button id="confirmYes" class="btn danger" disabled>Yes — Confirm</button>
      </div>
    </div>
  </div>

  <!-- Kill challenge modal (target) -->
  <div id="challengeModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Elimination Challenge</h3>
      <p id="challengeText" class="smallmuted"></p>
      <div style="text-align:right; margin-top:12px">
        <button id="challengeDeny" class="btn ghost">Deny</button>
        <button id="challengeConfirm" class="btn primary">Confirm</button>
      </div>
    </div>
  </div>
  
<!-- Confirm Identity Modal (Set PIN) -->
  <div id="confirmIdentityModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3 id="confirmIdentityModalTitle">Set Your PIN</h3>
      <p id="confirmIdentityModalText" class="smallmuted">Enter a 4-digit PIN to secure your identity. You'll need this PIN to reclaim your identity if you lose your session.</p>
      <div class="field">
        <input id="confirmIdentityInput" type="password" placeholder="Enter 4-digit PIN" maxlength="4" autocomplete="off" />
        <div id="confirmIdentityError" class="smallmuted" style="color:red; margin-top:6px; display:none;"></div>
      </div>
      <div style="text-align:right; margin-top:8px">
        <button id="confirmIdentityCancel" class="btn ghost">Cancel</button>
        <button id="confirmIdentityConfirm" class="btn primary" disabled>Confirm</button>
      </div>
    </div>
  </div>

  <!-- Reclaim Identity Modal -->
  <div id="reclaimModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Reclaim Your Identity</h3>
      <p class="smallmuted">Enter your player name and PIN to reclaim your identity.</p>
      <div class="field">
        <input id="reclaimNameInput" type="text" placeholder="Enter your player name" autocomplete="off" />
      </div>
      <div class="field">
        <input id="reclaimPinInput" type="password" placeholder="Enter your 4-digit PIN" maxlength="4" autocomplete="off" />
      </div>
      <div id="reclaimError" class="smallmuted" style="color:red; margin-top:6px; display:none;"></div>
      <div style="text-align:right; margin-top:8px">
        <button id="reclaimCancel" class="btn ghost">Cancel</button>
        <button id="reclaimSubmit" class="btn primary" disabled>Reclaim Identity</button>
      </div>
    </div>
  </div>
  <!-- Admin Panel -->
  <div id="adminPanel" class="hidden admin-panel">
    <h3>Admin Panel</h3>
    
    <div class="admin-actions">
      <button id="adminRefreshBtn" class="btn ghost">Refresh Players</button>
      <button id="adminShowDetailsBtn" class="btn ghost">Show Details</button>
      <button id="adminEndGameBtn" class="btn danger">End Game</button>
      <button id="adminDeleteGameBtn" class="btn danger">Delete Game</button>
    </div>

    <div class="players-container">
      <h4>Players</h4>
      <div id="adminPlayersList">
        <p>Loading players...</p>
      </div>
    </div>

    <!-- admin: Player Action Modal -->
    <div id="adminPlayerModal" class="modal-backdrop" role="dialog" aria-modal="true">
      <div class="modal">
        <h3 id="adminModalTitle">Player Actions</h3>
        <p id="adminModalText" class="smallmuted"></p>
        
        <div id="adminModalActions" style="margin-top: 12px;">
          <button id="adminResetPinBtn" class="btn ghost">Reset PIN</button>
          <button id="adminManualKillBtn" class="btn danger">Manual Elimination</button>
          <button id="adminPlayerLeaveBtn" class="btn ghost">Mark as Left</button>
        </div>
        
        <div style="text-align: right; margin-top: 12px;">
          <button id="adminModalClose" class="btn ghost">Close</button>
        </div>
      </div>
    </div>
  </div>
  <!-- admin: modal for resetting PIN -->
  <div id="adminResetPinModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Reset PIN for <span id="adminResetPinPlayerName"></span></h3>
      <p class="smallmuted">Enter a new 4-digit PIN for this player.</p>
      <div class="field">
        <input id="adminResetPinInput" type="password" placeholder="Enter new PIN" maxlength="4" autocomplete="off" />
        <div id="adminResetPinError" class="smallmuted" style="color:red; margin-top:6px; display:none;"></div>
      </div>
      <div style="text-align:right; margin-top:8px">
        <button id="adminResetPinCancel" class="btn ghost">Cancel</button>
        <button id="adminResetPinConfirm" class="btn primary" disabled>Reset PIN</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const socket = io();

  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"']/g, (s) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s]));
  }

  // Get game code
  function getGameCode() {
    const fromQuery = new URLSearchParams(window.location.search).get('gameCode') || new URLSearchParams(window.location.search).get('game');
    if (fromQuery) return fromQuery;
    const pathLast = window.location.pathname.split('/').filter(Boolean).pop();
    
    return pathLast;
  }

  // Reclaim modal validation
  function validateReclaimInputs() {
    const name = reclaimNameInput.value.trim();
    const pin = reclaimInput.value.trim();
    reclaimSubmit.disabled = !(name.length > 0 && pin.length === 4 && /^\d{4}$/.test(pin));
    reclaimError.style.display = 'none';
  }


  const gameCode = getGameCode();
  document.getElementById('gameCode').textContent = gameCode ? `Game: ${gameCode}` : 'Game';

  // Storage keys
  const creatorKey = `creator_${gameCode}`;
  const sessionKey = `session_${gameCode}`;
  const playerNameKey = `player_name_${gameCode}`;

  // Elements
  const connectionStatus = document.getElementById('connectionStatus');
  const playersListEl = document.getElementById('playersList');
  const selectedNameEl = document.getElementById('selectedPlayerName');
  const confirmIdentityBtn = document.getElementById('confirmIdentityBtn');
  const reclaimLobbyBtn = document.getElementById('reclaimLobbyBtn'); 
  const startGameContainer = document.getElementById('startGameContainer');
  const startGameBtn = document.getElementById('startGameBtn');

  const selectionPhase = document.getElementById('selectionPhase');

  const viewAlive = document.getElementById('viewAlive');
  const viewDead = document.getElementById('viewDead');
  const targetNameEl = document.getElementById('targetName');
  const taskTextEl = document.getElementById('taskText');
  const btnEliminate = document.getElementById('btnEliminate');
  const cooldownNote = document.getElementById('cooldownNote');

  const confirmModal = document.getElementById('confirmModal');
  const confirmSummary = document.getElementById('confirmSummary');
  const confirmInput = document.getElementById('confirmInput');
  const confirmCancel = document.getElementById('confirmCancel');
  const confirmYes = document.getElementById('confirmYes');

  const challengeModal = document.getElementById('challengeModal');
  const challengeText = document.getElementById('challengeText');
  const challengeDeny = document.getElementById('challengeDeny');
  const challengeConfirm = document.getElementById('challengeConfirm');

  const graveList = document.getElementById('graveList');
  const alertBox = document.getElementById('alert');
  const youNameSpan = document.getElementById('youName');
  
  const confirmIdentityModal = document.getElementById('confirmIdentityModal');
  const confirmIdentityModalTitle = document.getElementById('confirmIdentityModalTitle');
  const confirmIdentityModalText = document.getElementById('confirmIdentityModalText');
  const confirmIdentityInput = document.getElementById('confirmIdentityInput');
  const confirmIdentityCancel = document.getElementById('confirmIdentityCancel');
  const confirmIdentityConfirm = document.getElementById('confirmIdentityConfirm');
  const confirmIdentityError = document.getElementById('confirmIdentityError');

  const reclaimModal = document.getElementById('reclaimModal');
  const reclaimNameInput = document.getElementById('reclaimNameInput');
  const reclaimInput = document.getElementById('reclaimPinInput');
  const reclaimError = document.getElementById('reclaimError');
  const reclaimCancel = document.getElementById('reclaimCancel');
  const reclaimSubmit = document.getElementById('reclaimSubmit');

  const viewGameInProgress = document.getElementById('viewGameInProgress');
  const reclaimInGameBtn = document.getElementById('reclaimInGameBtn');

  // State
  let tentativelySelected = null;
  let mySession = localStorage.getItem(sessionKey) || null;
  let myName = localStorage.getItem(playerNameKey) || null;
  let pinMode = 'new'; // 'new' or 'reclaim'
  let pendingPlayerName = null;
  // IMPORTANT: detect creator via the exact key your create UI sets (reuse original pattern)
  let isCreator = !!localStorage.getItem(creatorKey);
  let role = 'lobby'; // 'lobby' | 'alive' | 'dead'
  let currentTarget = null;
  let currentTask = null;
  let pendingKiller = null;
  let eliminateCooldown = false;
  let gameStarted = false;

  function show(el){ el.classList.remove('hidden'); }
  function hide(el){ el.classList.add('hidden'); }
  function toast(msg){
    alertBox.textContent = msg;
    show(alertBox);
    setTimeout(()=> hide(alertBox), 2800);
  }

  // initialize displayed name from localStorage (if present)
  function updateDisplayedName(name) {
    myName = name || null;
    if (myName) {
      youNameSpan.textContent = myName;
    } else {
      youNameSpan.textContent = '—';
    }
  }

  function fillGraveyard(players){
    graveList.innerHTML = '';
    (players || []).forEach(p => {
      const li = document.createElement('li');
      li.className = 'list-item';
      li.innerHTML = `<div>${escapeHtml(p.name)}</div><div class="pill">${p.status === 'alive' ? '♥ alive' : '☠ eliminated'}</div>`;
      graveList.appendChild(li);
    });
  }

  // Show appropriate view based on game state and authentication
  function updateViewVisibility() {
    // Reset all views first
    hide(viewGameInProgress);
    hide(lobbySection);
    hide(viewAlive);
    hide(viewDead);
    
    // If game has started and user doesn't have a valid session
    if (gameStarted && !mySession) {
      show(viewGameInProgress);
      return;
    }
    
    // Show appropriate view based on role
    if (role === 'alive') {
      show(viewAlive);
    } else if (role === 'dead') {
      show(viewDead);
    } else {
      show(lobbySection);
    }
  }

  // Render the player list client-side using server data; include select/cancel buttons
  function renderPlayerList(players) {
    if (!players || players.length === 0) {
      playersListEl.innerHTML = '<p>No players found.</p>';
      return;
    }
    updateViewVisibility();
    const html = players.map(p => {
      const isMe = p.session_token && (p.session_token === mySession);
      const canSelect = p.status === 'not-joined' && !mySession && !gameStarted;
      const isTent = tentativelySelected === p.name;
      const statusClass = p.status === 'alive' ? 'status-alive' : 'status-not-joined';
      const statusText = p.status === 'alive' ? 'Joined' : 'Not Joined';
      const selectBtn = canSelect ? `<button class="btn ghost select-btn ${isTent ? 'selected' : ''}" data-name="${escapeHtml(p.name)}">${isTent? 'Selected' : 'Select'}</button>` : '';
      const myCancelBtn = isMe ? `<button class="btn ghost cancel-btn" data-name="${escapeHtml(p.name)}">Cancel</button>` : '';
      return `
        <div class="player-item">
          <div style="display:flex;gap:12px;align-items:center">
            <div class="player-name">${escapeHtml(p.name)} ${isMe ? '(You)' : ''}</div>
            <div class="player-status ${statusClass} pill">${statusText}</div>
          </div>
          <div>
            ${selectBtn} ${myCancelBtn}
          </div>
        </div>
      `;
    }).join('');
    playersListEl.innerHTML = html;

    // Update selection UI
    selectedNameEl.textContent = tentativelySelected || 'None';
    confirmIdentityBtn.disabled = !tentativelySelected;
  }

  // Simple HTML escaper for safety when rendering names
  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"']/g, (s) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s]));
  }

  // Delegated click handler for select/cancel buttons
  playersListEl.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    if (btn.classList.contains('select-btn')) {
      const name = btn.dataset.name;
      if (!name) return;
      if (tentativelySelected === name) tentativelySelected = null; else tentativelySelected = name;
      socket.emit('join-game', gameCode);
      selectedNameEl.textContent = tentativelySelected || 'None';
      confirmIdentityBtn.disabled = !tentativelySelected;
    } else if (btn.classList.contains('cancel-btn')) {
      if (!mySession) return;
      socket.emit('cancel-identity', { gameCode, sessionToken: mySession });
    }
  });

  // identity confirm (Set PIN)
  confirmIdentityBtn.addEventListener('click', () => {
    if (!tentativelySelected) return;
    pendingPlayerName = tentativelySelected;
    confirmIdentityInput.value = '';
    confirmIdentityConfirm.disabled = true;
    confirmIdentityError.style.display = 'none';
    confirmIdentityModal.classList.add('open');
    confirmIdentityInput.focus();
  });

  // PIN input validation
  confirmIdentityInput.addEventListener('input', () => {
    const value = confirmIdentityInput.value.trim();
    if (value === '') {
      confirmIdentityConfirm.disabled = true;
      confirmIdentityError.style.display = 'none';
    } else if (!/^\d{4}$/.test(value)) {
      confirmIdentityConfirm.disabled = true;
      confirmIdentityError.textContent = 'PIN must be exactly 4 digits';
      confirmIdentityError.style.display = 'block';
    } else {
      confirmIdentityConfirm.disabled = false;
      confirmIdentityError.style.display = 'none';
    }
  });

  confirmIdentityInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !confirmIdentityConfirm.disabled) {
        confirmIdentityConfirm.click();
    }
  });

  confirmIdentityCancel.addEventListener('click', () => {
    confirmIdentityModal.classList.remove('open');
  });

  confirmIdentityConfirm.addEventListener('click', () => {
    const pin = confirmIdentityInput.value.trim();
    if (pin.length === 4 && /^\d{4}$/.test(pin) && pendingPlayerName) {
      socket.emit('claim-identity', { gameCode, playerName: pendingPlayerName, pin });
      confirmIdentityModal.classList.remove('open');
    }
  });

  // Show reclaim modal
  reclaimLobbyBtn.addEventListener('click', () => {
    reclaimNameInput.value = '';
    reclaimInput.value = '';
    reclaimError.style.display = 'none';
    reclaimSubmit.disabled = true;
    reclaimModal.classList.add('open');
    reclaimNameInput.focus();
  });

  reclaimNameInput.addEventListener('input', validateReclaimInputs);

  reclaimInput.addEventListener('input', validateReclaimInputs);
  
  reclaimInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !reclaimSubmit.disabled) {
        reclaimSubmit.click();
    }
  });

  reclaimCancel.addEventListener('click', () => {
    reclaimModal.classList.remove('open');
  });

  reclaimSubmit.addEventListener('click', () => {
    const name = reclaimNameInput.value.trim();
    const pin = reclaimInput.value.trim();
    if (name && pin.length === 4 && /^\d{4}$/.test(pin)) {
      socket.emit('reclaim-identity', { gameCode, playerName: name, pin });
      reclaimModal.classList.remove('open');
    }
  });

  startGameBtn.addEventListener('click', () => {
    const creatorToken = localStorage.getItem(creatorKey);
    if (!creatorToken) { toast('Creator token missing'); return; }
    socket.emit('start-game', { gameCode, creatorToken });
  });

  // eliminate flow - typed confirm modal
  btnEliminate.addEventListener('click', () => {
    if (role !== 'alive') return;
    if (eliminateCooldown) return;
    if (!currentTarget || !currentTask) { toast('No assigned target or task'); return; }
    confirmSummary.textContent = `You are about to claim the elimination of "${currentTarget.name}" by doing: "${currentTask}". This will send a challenge to them for verification.`;
    confirmInput.value = '';
    confirmYes.disabled = true;
    confirmModal.classList.add('open');
    confirmInput.focus();
  });

  confirmInput.addEventListener('input', () => {
    const typed = confirmInput.value.trim().toLowerCase();
    const targetName = (currentTarget && currentTarget.name) ? currentTarget.name.trim().toLowerCase() : '';
    
    if (typed === '') {
    confirmYes.disabled = true;
    confirmError.style.display = 'none';
    } else if (typed !== targetName) {
    confirmYes.disabled = true;
    confirmError.textContent = 'Target name does not match!';
    confirmError.style.display = 'block';
    } else {
    confirmYes.disabled = false;
    confirmError.style.display = 'none';
    }
  });

  confirmInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !confirmYes.disabled) {
        confirmYes.click();
    }
    });

  confirmCancel.addEventListener('click', () => { confirmModal.classList.remove('open'); });

  confirmYes.addEventListener('click', () => {
    confirmModal.classList.remove('open');
    eliminateCooldown = true;
    btnEliminate.disabled = true;
    cooldownNote.textContent = 'Cooldown...';
    setTimeout(()=> { eliminateCooldown = false; btnEliminate.disabled = false; cooldownNote.textContent=''; }, 1000);

    const sessionToken = mySession;
    socket.emit('claim-kill', { sessionToken, session_token: sessionToken, gameCode });
    toast('Claim sent — waiting for target response');
  });

  challengeDeny.addEventListener('click', () => {
    challengeModal.classList.remove('open');
    if (!pendingKiller) return;
    socket.emit('resolve-kill', { sessionToken: mySession, session_token: mySession, killer_id: pendingKiller, answer: 'deny' });
    pendingKiller = null;
    toast('You denied the claim');
  });

  challengeConfirm.addEventListener('click', () => {
    challengeModal.classList.remove('open');
    if (!pendingKiller) return;
    socket.emit('resolve-kill', { sessionToken: mySession, session_token: mySession, killer_id: pendingKiller, answer: 'confirm' });
    pendingKiller = null;
    toast('You confirmed the claim');
  });

  // Reclaim button in game progress view
  reclaimInGameBtn.addEventListener('click', () => {
    reclaimNameInput.value = '';
    reclaimInput.value = '';
    reclaimError.style.display = 'none';
    reclaimSubmit.disabled = true;
    reclaimModal.classList.add('open');
    reclaimNameInput.focus();
  });

  socket.on('connect', () => {
    connectionStatus.textContent = 'Connected to game';
    connectionStatus.className = 'connection-status connected';
    
    // Restore session from localStorage if available
    if (mySession) {
      socket.data = { sessionToken: mySession };
    }
    socket.emit('join-game', gameCode);
  });

  socket.on('disconnect', () => {
    connectionStatus.textContent = 'Disconnected - trying to reconnect...';
    connectionStatus.className = 'connection-status disconnected';
  });

  // handle server identity responses
  socket.on('identity-confirmed', (data) => {
    mySession = data.sessionToken;
    myName = data.playerName;
    localStorage.setItem(sessionKey, mySession);
    localStorage.setItem(playerNameKey, myName);
    updateDisplayedName(myName);
    updateViewVisibility();
    toast(`You are now ${myName}`);
    socket.emit('join-game', gameCode);
  });

  socket.on('identity-reclaimed', (data) => {
    mySession = data.sessionToken;
    myName = data.playerName;
    localStorage.setItem(sessionKey, mySession);
    localStorage.setItem(playerNameKey, myName);
    updateDisplayedName(myName);
    updateViewVisibility();
    toast(`Identity reclaimed: ${myName}`);
    socket.emit('join-game', gameCode);
  });

  socket.on('identity-canceled', (data) => {
    mySession = null;
    myName = null;
    localStorage.removeItem(sessionKey);
    localStorage.removeItem(playerNameKey);
    updateDisplayedName(null);                 // <-- clear visible name
    tentativelySelected = null;
    selectedNameEl.textContent = 'None';
    confirmIdentityBtn.disabled = true;
    updateViewVisibility();
    socket.emit('join-game', gameCode);
  });

  socket.on('session-invalidated', () => {
    // Clear session and player name from storage
    mySession = null;
    myName = null;
    localStorage.removeItem(sessionKey);
    localStorage.removeItem(playerNameKey);
    updateDisplayedName(null);
    tentativelySelected = null;
    selectedNameEl.textContent = 'None';
    confirmIdentityBtn.disabled = true;
    show(selectionPhase);
    reclaimLobbyBtn.style.display = 'inline-block';
    reclaimLobbyBtn.disabled = false;
    toast('Your session was reclaimed elsewhere. Please select or reclaim your identity.');
    socket.emit('join-game', gameCode);
  });

  // When server sends player-list-update: render it
  socket.on('player-list-update', (players) => {
    renderPlayerList(players || []);

    // Check if we have a session and find our player data
    if (mySession) {
      const myPlayer = players.find(p => p.session_token === mySession);
      if (myPlayer) {
        // Update our role based on the server's data
        if (myPlayer.status === 'eliminated' || myPlayer.status === 'left') {
          role = 'dead';
          updateViewVisibility();
          fillGraveyard(players || []);
        } else if (myPlayer.status === 'alive'&& gameStarted) {
          role = 'alive';
          updateViewVisibility();
          // We'll wait for the your-assignment event to populate target/task
        }
      }
    }
    
    // creator logic for start button — use inline style toggles like original code
    if (isCreator) {
      startGameContainer.style.display = 'block';
      const allJoined = players.length > 0 && players.every(p => p.status === 'alive');
      startGameBtn.disabled = !allJoined;
      startGameBtn.textContent = allJoined ? 'Start Game' : `Waiting (${players.filter(p=>p.status==='alive').length}/${players.length})`;
    } else {
      startGameContainer.style.display = 'none';
    }
    // If we are dead, show roster in grave
    if (role === 'dead') fillGraveyard(players || []);
  });

  // your assignment private DM
  socket.on('your-assignment', ({ target, task }) => {
    role = 'alive';
    currentTarget = target;
    currentTask = task;
    targetNameEl.textContent = currentTarget ? currentTarget.name : '—';
    taskTextEl.textContent = currentTask || '—';
    updateViewVisibility();
  });

  socket.on('game-started', () => {
    gameStarted = true;
    toast('Game started!');
    socket.emit('join-game', gameCode); // cause lobby update + server DMs
  });

  // target challenge modal
  socket.on('kill-challenge', ({ killer_id, killer_name, task }) => {
    pendingKiller = killer_id;
    challengeText.textContent = `${killer_name} claims they eliminated you by making you do: "${task}". Do you confirm?`;
    challengeModal.classList.add('open');
  });

  socket.on('kill-denied', () => { toast('Your kill was denied.'); });

  socket.on('player-eliminated', ({ name, id }) => {
    if (role === 'dead') {
     toast(`${name} eliminated`);
    socket.emit('join-game', gameCode);
  }
  });

  socket.on('target-left', (data) => {
    toast(`Your target (${data.targetName}) has left the game. Waiting for new assignment.`);
    // Clear the current target
    currentTarget = null;
    targetNameEl.textContent = '—';
    updateViewVisibility();
  });

  socket.on('you-eliminated', () => {
    role = 'dead';
    updateViewVisibility();
    socket.emit('join-game', gameCode);
  });

  socket.on('new-target', ({ target, task }) => {
    currentTarget = target || null;
    currentTask = task || null;
    if (role === 'alive') {
      targetNameEl.textContent = currentTarget ? currentTarget.name : '—';
      taskTextEl.textContent = currentTask || '—';
    }
    toast('New target received');
  });

  socket.on('game-over', ({ winner_id, winner_name }) => {
    toast(`Game over — winner: ${winner_name}`);
  });

  socket.on('navigate-victory', ({ gameCode }) => {
    window.location.href = `/victory.html?gameCode=${gameCode}`;
  });

  // Track game state from server events
  socket.on('game-state', (state) => {
      // Redirect to victory page if game is finished
    if (state === 'finished') {
      window.location.href = `/victory.html?gameCode=${gameCode}`;
      return;
    }
    if ( state === 'active')
      gameStarted = state === 'active';
    updateViewVisibility();
  });

  socket.on('game-created', () => {
    gameStarted = false;
    updateViewVisibility();
  });

  socket.on('game-ended', () => {
    gameStarted = false;
    updateViewVisibility();
  });


  // ==== Admin ====

  const adminPanel = document.getElementById('adminPanel');
  const adminRefreshBtn = document.getElementById('adminRefreshBtn');
  const adminShowDetailsBtn = document.getElementById('adminShowDetailsBtn');
  const adminEndGameBtn = document.getElementById('adminEndGameBtn');
  const adminDeleteGameBtn = document.getElementById('adminDeleteGameBtn');
  const adminPlayersList = document.getElementById('adminPlayersList');
  const adminPlayerModal = document.getElementById('adminPlayerModal');
  const adminModalTitle = document.getElementById('adminModalTitle');
  const adminModalText = document.getElementById('adminModalText');
  const adminResetPinBtn = document.getElementById('adminResetPinBtn');
  const adminManualKillBtn = document.getElementById('adminManualKillBtn');
  const adminPlayerLeaveBtn = document.getElementById('adminPlayerLeaveBtn');
  const adminModalClose = document.getElementById('adminModalClose');
  const adminResetPinModal = document.getElementById('adminResetPinModal');
  const adminResetPinPlayerName = document.getElementById('adminResetPinPlayerName');
  const adminResetPinInput = document.getElementById('adminResetPinInput');
  const adminResetPinError = document.getElementById('adminResetPinError');
  const adminResetPinCancel = document.getElementById('adminResetPinCancel');
  const adminResetPinConfirm = document.getElementById('adminResetPinConfirm');
  

  let showDetails = false;
  let currentAdminPlayer = null;

  // Check if user is creator and show admin panel
  function checkAdminStatus() {
    const creatorToken = localStorage.getItem(`creator_${gameCode}`);
    if (creatorToken) {
      show(adminPanel);
      loadAdminPlayers(false);
    } else {
      hide(adminPanel);
    }
  }

  function loadAdminPlayers(withDetails = false) {
    const creatorToken = localStorage.getItem(`creator_${gameCode}`);
    if (!creatorToken) return;

    socket.emit('admin-get-players', {
      gameCode,
      creatorToken,
      showDetails: withDetails
    });
  }

  function renderAdminPlayers(players) {
    if (!players || players.length === 0) {
      adminPlayersList.innerHTML = '<p>No players found.</p>';
      return;
    }

    const html = players.map(player => {
      const statusClass = `admin-status status-${player.status}`;
      const statusText = player.status.charAt(0).toUpperCase() + player.status.slice(1);
      
      let detailsHtml = '';
      if (showDetails) {
        detailsHtml = `
          <div class="smallmuted">
            ${player.target_name ? `Target: ${escapeHtml(player.target_name)}<br>` : ''}
            ${player.task ? `Task: ${escapeHtml(player.task)}<br>` : ''}
            PIN: ${player.has_pin ? 'Set' : 'Not set'}
          </div>
        `;
      }

      return `
        <div class="admin-player-item">
          <div class="admin-player-info">
            <div>${escapeHtml(player.name)}</div>
             ${showDetails ? `<div class="${statusClass}">${statusText}</div>` : ''}
          ${detailsHtml}
          </div>
          <div class="admin-player-actions">
            <button class="btn ghost admin-action-btn" data-player-id="${player.id}" data-player-name="${escapeHtml(player.name)}">
              Actions
            </button>
          </div>
        </div>
      `;
    }).join('');

    adminPlayersList.innerHTML = html;

    // Add event listeners to action buttons
    document.querySelectorAll('.admin-action-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const playerId = e.target.dataset.playerId;
        const playerName = e.target.dataset.playerName;
        showPlayerActions(playerId, playerName);
      });
    });
  }

  function showPlayerActions(playerId, playerName) {
    currentAdminPlayer = { id: playerId, name: playerName };
    adminModalTitle.textContent = `Actions for ${playerName}`;
    adminModalText.textContent = `Choose an action for ${playerName}`;
    adminPlayerModal.classList.add('open');
  }

  // Event listeners
  adminRefreshBtn.addEventListener('click', () => {
    loadAdminPlayers(showDetails);
  });

  adminShowDetailsBtn.addEventListener('click', () => {
    showDetails = !showDetails;
    adminShowDetailsBtn.textContent = showDetails ? 'Hide Details' : 'Show Details';
    loadAdminPlayers(showDetails);
  });

  adminEndGameBtn.addEventListener('click', () => {
    if (confirm('Are you sure you want to end the game? All remaining players will win.')) {
      const creatorToken = localStorage.getItem(`creator_${gameCode}`);
      socket.emit('admin-end-game', { gameCode, creatorToken });
    }
  });

  adminDeleteGameBtn.addEventListener('click', () => {
    if (confirm('Are you sure you want to delete this game? This action cannot be undone.')) {
      const creatorToken = localStorage.getItem(`creator_${gameCode}`);
      socket.emit('admin-delete-game', { gameCode, creatorToken });
    }
  });

  adminResetPinBtn.addEventListener('click', () => {
    if (!currentAdminPlayer) return;
    
    adminResetPinPlayerName.textContent = currentAdminPlayer.name;
    adminResetPinInput.value = '';
    adminResetPinError.style.display = 'none';
    adminResetPinConfirm.disabled = true;
    adminResetPinModal.classList.add('open');
    adminResetPinInput.focus();
  });

  // Validate PIN input
  adminResetPinInput.addEventListener('input', () => {
    const value = adminResetPinInput.value.trim();
    if (value === '') {
      adminResetPinConfirm.disabled = true;
      adminResetPinError.style.display = 'none';
    } else if (!/^\d{4}$/.test(value)) {
      adminResetPinConfirm.disabled = true;
      adminResetPinError.textContent = 'PIN must be exactly 4 digits';
      adminResetPinError.style.display = 'block';
    } else {
      adminResetPinConfirm.disabled = false;
      adminResetPinError.style.display = 'none';
    }
  });

  adminResetPinInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !adminResetPinConfirm.disabled) {
      adminResetPinConfirm.click();
    }
  });

  adminResetPinCancel.addEventListener('click', () => {
    adminResetPinModal.classList.remove('open');
  });

  adminResetPinConfirm.addEventListener('click', () => {
    const newPin = adminResetPinInput.value.trim();
    if (newPin.length === 4 && /^\d{4}$/.test(newPin) && currentAdminPlayer) {
      const creatorToken = localStorage.getItem(`creator_${gameCode}`);
      socket.emit('admin-reset-pin', {
        gameCode,
        creatorToken,
        playerId: currentAdminPlayer.id,
        newPin
      });
      adminResetPinModal.classList.remove('open');
    }
  });

  // Update the success handler for pin reset
  socket.on('admin-pin-reset', (data) => {
    toast('PIN reset successfully');
    loadAdminPlayers(showDetails);
    adminPlayerModal.classList.remove('open');
  });

  adminManualKillBtn.addEventListener('click', () => {
    if (!currentAdminPlayer) return;
    
    if (confirm(`Manually eliminate ${currentAdminPlayer.name}? This will count as a kill for their assassin.`)) {
      const creatorToken = localStorage.getItem(`creator_${gameCode}`);
      socket.emit('admin-manual-kill', {
        gameCode,
        creatorToken,
        playerId: currentAdminPlayer.id
      });
    }
  });

  adminPlayerLeaveBtn.addEventListener('click', () => {
    if (!currentAdminPlayer) return;
    
    if (confirm(`Mark ${currentAdminPlayer.name} as left? This will NOT count as a kill.`)) {
      const creatorToken = localStorage.getItem(`creator_${gameCode}`);
      socket.emit('admin-player-leave', {
        gameCode,
        creatorToken,
        playerId: currentAdminPlayer.id
      });
    }
  });

  adminModalClose.addEventListener('click', () => {
    adminPlayerModal.classList.remove('open');
    currentAdminPlayer = null;
  });

  // Socket event handlers for admin panel
  socket.on('admin-players-list', (data) => {
    renderAdminPlayers(data.players);
  });

  socket.on('admin-pin-reset', (data) => {
    toast(`PIN reset for player. New PIN: ${data.newPin}`);
    loadAdminPlayers(showDetails);
    adminPlayerModal.classList.remove('open');
  });

  socket.on('admin-manual-kill-success', () => {
    toast('Manual elimination processed');
    loadAdminPlayers(showDetails);
    adminPlayerModal.classList.remove('open');
  });

  socket.on('admin-player-leave-success', () => {
    toast('Player marked as left');
    loadAdminPlayers(showDetails);
    adminPlayerModal.classList.remove('open');
  });

  socket.on('admin-end-game-success', () => {
    toast('Game ended successfully');
  });

  socket.on('admin-delete-game-success', () => {
    toast('Game deleted successfully');
    window.location.href = '/';
  });

  // Check admin status on page load and when game state changes
  setTimeout(checkAdminStatus, 100);
  socket.on('player-list-update', checkAdminStatus);
  socket.on('game-state', checkAdminStatus);

  
  // ==== 




  updateDisplayedName(localStorage.getItem(playerNameKey));

  // Ensure startGameContainer visible if creator (initial)
  if (isCreator) startGameContainer.style.display = 'block';

  // initial UI
  if (mySession) {
  // We have a session, so we're already logged in
  hide(selectionPhase);
  // Immediately try to restore our game state
  socket.emit('join-game', gameCode);
  // Set a timeout to check if we receive game state, if not, request it
  setTimeout(() => {
    if (role === 'lobby' && mySession) {
      // We're still in lobby view but have a session - request game state
      socket.emit('join-game', gameCode);
    }
  }, 1000);
} else {
  show(selectionPhase);
  confirmIdentityBtn.disabled = true;
  reclaimLobbyBtn.style.display = 'inline-block';
  reclaimLobbyBtn.disabled = false;
}
})();
</script>
</body>
</html>
