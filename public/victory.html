<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Killer — Victory</title>
<link rel="stylesheet" href="/css/victory.css">
</head>
<body>
  <div class="container">
    <h1 id="winnerName">Winner: —</h1>

    <h2>Kill History</h2>
    <table>
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Killer</th>
          <th>Victim</th>
          <th>Task</th>
        </tr>
      </thead>
      <tbody id="historyTable"></tbody>
    </table>

    <h2>Kill Count</h2>
    <table>
      <thead>
        <tr>
          <th>Player</th>
          <th>Kills</th>
        </tr>
      </thead>
      <tbody id="killCountTable"></tbody>
    </table>
  </div>
<script>
(async () => {
  const params = new URLSearchParams(window.location.search);
  const gameCode = params.get('gameCode');
  if (!gameCode) return;

  // Get session token from localStorage using the per-game key
  const sessionKey = `session_${gameCode}`;
  const sessionToken = localStorage.getItem(sessionKey);

  const res = await fetch(`/api/game-summary?gameCode=${gameCode}&sessionToken=${sessionToken}`);
  const data = await res.json();

  document.getElementById('winnerName').textContent = `Winner: ${data.winner_name || '—'}`;

  const historyTable = document.getElementById('historyTable');
  data.kill_history.forEach(k => {
    const tr = document.createElement('tr');

    // Highlight if the current player was the killer
    if (k.is_own_kill) tr.classList.add('highlight');

    tr.innerHTML = `
      <td>${new Date(k.timestamp).toLocaleString()}</td>
      <td>${k.killer_name}</td>
      <td>${k.victim_name}</td>
      <td>${k.task || ''}</td>
    `;
    historyTable.appendChild(tr);
  });

  const killCountTable = document.getElementById('killCountTable');
  data.kill_count.forEach(({ name, count }) => {
    const tr = document.createElement('tr');
    if (name === data.current_player_name) tr.classList.add('highlight');
    tr.innerHTML = `<td>${name}</td><td>${count}</td>`;
    killCountTable.appendChild(tr);
  });
})();
</script>

</body>
</html>
